name: Hourly 511 Data Sync

on:
  schedule:
    - cron: "22 * * * *"  # :22 past every hour (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch 511 data
        env:
          GNB511_API_KEY: ${{ secrets.GNB511_API_KEY }}
        shell: python
        run: |
          """Fetch 511 NB transportation data (webcams, winter roads, ferries, events)."""
          import os
          import json
          import time
          from datetime import datetime
          import requests

          # =============================================================================
          # Configuration
          # =============================================================================

          API_KEY = os.environ.get("GNB511_API_KEY", "").strip()
          API_BASE = "https://511.gnb.ca/api/v2/get"
          OUTPUT_DIR = "511"
          TIMEOUT = 120
          RETRIES = 3

          DATASETS = {
              "webcams":     {"slug": "cameras", "params": {"lang": "en"}},
              "winterroads": {"slug": "winterroads", "params": {}},
              "ferries":     {"slug": "ferryterminals", "params": {}},
              "events":      {"slug": "event", "params": {}},
          }

          # =============================================================================
          # Helpers
          # =============================================================================

          def log(msg: str) -> None:
              ts = time.strftime("%H:%M:%S", time.gmtime())
              print(f"[{ts}] {msg}", flush=True)

          def fetch_json(url: str, params: dict) -> dict | list | None:
              """Fetch JSON with retry logic."""
              for attempt in range(1, RETRIES + 1):
                  try:
                      log(f"  GET {url} (attempt {attempt})")
                      r = requests.get(url, params=params, timeout=TIMEOUT)
                      r.raise_for_status()
                      return r.json()
                  except Exception as e:
                      log(f"  Error: {e}")
                      time.sleep(1 * attempt)
              return None

          def add_timestamp(data: dict | list, ts: str) -> dict | list:
              """Add downloaded_at timestamp to data."""
              if isinstance(data, list):
                  return [{**item, "downloaded_at": ts} for item in data]
              return {**data, "downloaded_at": ts}

          # =============================================================================
          # Main
          # =============================================================================

          if not API_KEY:
              raise SystemExit("Missing GNB511_API_KEY secret")

          os.makedirs(OUTPUT_DIR, exist_ok=True)
          timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

          for name, config in DATASETS.items():
              log(f"Fetching {name}...")
              
              url = f"{API_BASE}/{config['slug']}"
              params = {"key": API_KEY, "format": "json", **config["params"]}
              
              data = fetch_json(url, params)
              
              if data is not None:
                  data = add_timestamp(data, timestamp)
                  output_path = os.path.join(OUTPUT_DIR, f"{name}.json")
                  
                  with open(output_path, "w", encoding="utf-8") as f:
                      json.dump(data, f, ensure_ascii=False)
                      f.write("\n")
                  
                  log(f"  Wrote {output_path}")
              else:
                  log(f"  FAILED - skipping {name}")

          log("Done")

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain 511/)" ]; then
            git add 511/
            git commit -m "Updated $(TZ=America/Moncton date +'%Y/%m/%d %I:%M %p')"
            git push
          else
            echo "No changes to commit"
          fi
